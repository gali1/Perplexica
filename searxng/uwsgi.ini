[uwsgi]
########################################
# uWSGI Configuration for SearxNG
# Optimized for Performance, Stability, and Low Latency
########################################

# --- Core Application Settings ---
master = true
module = searx.webapp
callable = app
single-interpreter = true
lazy-apps = false
enable-threads = true
offload-threads = 4

# --- Working Environment ---
uid = searxng
gid = searxng
chdir = /usr/local/searxng/searx/
pythonpath = /usr/local/searxng/

# --- Process Management ---
# Automatically match workers to available CPU cores
workers = %k
threads = 4
cheaper-algo = busyness
cheaper = 2
cheaper-initial = 4
cheaper-step = 1
cheaper-overload = 5
no-orphans = true
vacuum = true

# --- Memory & Worker Lifecycle ---
max-requests = 5000
max-requests-delta = 500
reload-on-rss = 512
evil-reload-on-rss = 768
max-worker-lifetime = 3600
worker-reload-mercy = 60
harakiri = 120
harakiri-verbose = true

# --- Networking & Socket Configuration ---
socket = 0.0.0.0:8080
http-socket = 0.0.0.0:8080
protocol = http
http-keepalive = 75
http-timeout = 75
socket-timeout = 60
listen = 1024
chmod-socket = 666
vacuum = true
die-on-term = true

# --- Buffers & Request Handling ---
buffer-size = 65535
post-buffering = 8192
thunder-lock = true
add-header = Connection: close
max-worker-lifetime = 3600

# --- Logging & Monitoring ---
disable-logging = false
log-4xx = true
log-5xx = true
logto = /var/log/uwsgi/searxng.log
log-maxsize = 52428800
log-backupname = /var/log/uwsgi/searxng.log.old
logdate = true
log-prefix = [SearxNG]
memory-report = true
stats = 127.0.0.1:9191
stats-http = true

# --- Async / Greenlet Optimization ---
gevent = 250
gevent-early-monkey-patch = true
async = 250
ugreen = true

# --- Security ---
uid = searxng
gid = searxng
cap = setgid,setuid
vacuum = true

# --- CPU & Scheduling ---
priority = 10
cpu-affinity = 1

# --- Static Content Optimization ---
static-map = /static=/usr/local/searxng/searx/static
check-static = /usr/local/searxng/searx/static
static-expires = /* 7776000
static-gzip-all = true
offload-threads = 4

# --- HTTP Response Optimization ---
add-header = Connection: Keep-Alive
route-user-agent = .* addheader:X-Robots-Tag: noindex, nofollow
route-user-agent = .* addheader:Referrer-Policy: no-referrer

# --- Performance & Safety ---
ignore-sigpipe = true
ignore-write-errors = true
disable-write-exception = true
cheap = false
auto-procname = true
vacuum = true

# --- Graceful Shutdown ---
hook-master-start = unix_signal:15 gracefully_kill_them_all
